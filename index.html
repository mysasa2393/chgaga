<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ›¼é¯Šé¯Šè–èª•åˆ®åˆ®æ¨‚ ğŸ„</title>
  <style>
    /* ----- å…¨å±€è¦–è¦ºé¢¨æ ¼ ----- */
    body { 
      text-align: center; 
      font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; 
      background: #FFF5EE; 
      margin: 0; 
      overscroll-behavior: none; 
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      color: #333;
    }
    
    h2 { color: #c62828; margin-bottom: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }

    /* ----- å…¬å‘Šå€å¡Š ----- */
    #noticeBoard {
      width: 85%;
      max-width: 400px;
      margin: 0 auto 15px auto; 
      padding: 12px 15px;
      background-color: #fff8e1; 
      border: 2px dashed #ff8f00; 
      border-radius: 12px;
      color: #5d4037;
      font-size: 14px;
      line-height: 1.6;
      display: none; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    #noticeBoard::before { content: "ğŸ”” æ´»å‹•å…¬å‘Šï¼š"; font-weight: bold; color: #d84315; }

    /* ----- é€²åº¦æ¢å€ ----- */
    #loadingContainer { width: 80%; max-width: 300px; margin: 15px auto; display: none; }
    #statusMessage { font-size: 1.1em; color: #c62828; margin-bottom: 10px; font-weight: bold; }
    .progress-box { width: 100%; height: 18px; background-color: #e0e0e0; border-radius: 10px; border: 2px solid #2e7d32; overflow: hidden; }
    .progress-bar {
      width: 0%; height: 100%;
      background: repeating-linear-gradient(45deg, #c62828, #c62828 12px, #ffffff 12px, #ffffff 24px);
      transition: width 0.5s ease; /* å¢åŠ éæ¸¡æ™‚é–“è®“ç§»å‹•æ›´å¹³æ»‘ */
      animation: candy-move 1s linear infinite;
    }
    @keyframes candy-move { from { background-position: 0 0; } to { background-position: 33.9px 0; } }

    /* ----- åˆ®åˆ®æ¨‚ä¸»é«” ----- */
    .wrapper { 
      position: relative; 
      width: 300px; height: 150px; 
      margin: 20px auto; 
      user-select: none; -webkit-user-select: none;
      display: none; 
      border: 6px solid #c62828; border-radius: 18px;
      box-shadow: 0 8px 20px rgba(198, 40, 40, 0.25);
    }
    
    #prize {
      font-size: 24px; font-weight: bold; color: #2e7d32; 
      text-align: center; line-height: 150px;
      position: absolute; width: 100%; height: 100%;
      background: white; border-radius: 12px;
    }

    #scratchCanvas { position: absolute; top: 0; left: 0; border-radius: 12px; cursor: crosshair; z-index: 2; transition: opacity 0.8s ease; }
    #hint { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 18px; color: #fff; font-weight: bold; text-shadow: 1px 1px 4px rgba(0,0,0,0.8); animation: pulse 1.2s infinite; pointer-events: none; z-index: 3; }
    @keyframes pulse { 0%, 100% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 50% { opacity: 0.6; transform: translate(-50%, -50%) scale(1.1); } }

    /* ----- æŒ‰éˆ•èˆ‡é€£çµ ----- */
    #actionArea { margin-top: 25px; min-height: 60px; }
    #rewardLink {
      display: none; margin-top: 15px; font-size: 16px; color: white;
      background-color: #2e7d32; padding: 14px 28px; text-decoration: none;
      border-radius: 50px; font-weight: bold; box-shadow: 0 4px 10px rgba(46, 125, 50, 0.3);
    }
    #revealBtn { margin-top: 10px; padding: 10px 20px; font-size: 16px; border: none; border-radius: 8px; background: #fbc02d; color: #333; font-weight: bold; cursor: pointer; display: none; }
    .error-msg { color: #c62828; font-weight: bold; margin: 15px; }

    #inputSection { padding: 25px; background: white; width: 85%; max-width: 380px; border-radius: 15px; border: 2px solid #2e7d32; box-shadow: 0 4px 15px rgba(46, 125, 50, 0.15); display: none; }
    input { padding: 12px; font-size: 16px; width: 65%; border: 1px solid #ccc; border-radius: 8px; }
    #searchBtn { padding: 12px 20px; font-size: 16px; background: #c62828; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
  </style>
</head>
<body>

  <h2>ğŸ„ æ›¼é¯Šé¯Šè–èª•åˆ®åˆ®æ¨‚ ğŸ…</h2>
  <div id="noticeBoard"></div>

  <div id="loadingContainer">
    <div id="statusMessage">ğŸ… è–èª•è€å…¬å…¬æ­£åœ¨æŸ¥è©¢...</div>
    <div class="progress-box"><div id="progressBar" class="progress-bar"></div></div>
  </div>

  <div id="errorArea" class="error-msg"></div>

  <div id="inputSection">
    <div style="margin-bottom:12px; font-weight:bold; color:#2e7d32;">ğŸ è¼¸å…¥åºè™Ÿé ˜é©šå–œï¼š</div>
    <input type="text" id="serialInput" placeholder="XMAS-2025">
    <button id="searchBtn" onclick="manualStart()">é–‹å§‹</button>
  </div>

  <div class="wrapper" id="scratchWrapper">
    <div id="prize">è¼‰å…¥ä¸­...</div>
    <canvas id="scratchCanvas" width="300" height="150"></canvas>
    <div id="hint">ğŸ‘‰ åˆ®é–‹é‡‘è‰²åœ–å±¤é ˜ç¦®ç‰©ï¼</div>
  </div>

  <div id="actionArea">
    <a id="rewardLink" href="#" target="_blank"></a>
    <br>
    <button id="revealBtn">ç›´æ¥æ‰“é–‹ç¦®ç‰© ğŸ</button>
  </div>

  <script>
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxHEwjdt1URWlRsDpuZFn-Mgqi62l_vSjtAa9up21d37UblgtnNPQgmW3SkDZTe_S2jtw/exec";
    
    const canvas = document.getElementById("scratchCanvas");
    const ctx = canvas.getContext("2d");
    const prizeDiv = document.getElementById("prize");
    const rewardLink = document.getElementById("rewardLink");
    const revealBtn = document.getElementById("revealBtn");
    const hint = document.getElementById("hint");
    const wrapper = document.getElementById("scratchWrapper");
    const noticeBoard = document.getElementById("noticeBoard");
    const loadingContainer = document.getElementById("loadingContainer");
    const progressBar = document.getElementById("progressBar");
    const errorArea = document.getElementById("errorArea");
    
    let prizeUrlData = ""; 
    let progressInterval;
    let isDrawing = false;
    let firstScratch = false;

    window.onload = function() {
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        if (code) startLottery(code);
        else {
            document.getElementById("inputSection").style.display = "block";
            fetch(`${GAS_API_URL}?action=getNotice`).then(res => res.json()).then(data => updateNotice(data.notice));
        }
    };

    function updateNotice(text) { if (text) { noticeBoard.innerText = text; noticeBoard.style.display = "block"; } }

    function manualStart() {
        const code = document.getElementById("serialInput").value.trim();
        if(!code) return alert("è«‹è¼¸å…¥åºè™Ÿ");
        document.getElementById("inputSection").style.display = "none";
        startLottery(code);
    }

    // --- ä¿®æ”¹è™•ï¼šæ›´å¹³ç©©ç·©æ…¢çš„é€²åº¦æ¢ ---
    function startLoading() {
        loadingContainer.style.display = "block"; 
        errorArea.innerText = ""; 
        progressBar.style.width = "0%";
        let width = 0;

        // æ¯ 250 æ¯«ç§’æ›´æ–°ä¸€æ¬¡ï¼Œé€Ÿåº¦æ›´æœ‰ç¯€å¥æ„Ÿ
        progressInterval = setInterval(() => {
            if (width < 50) {
                width += Math.random() * 3; // åˆæœŸï¼šç©©å®š
            } else if (width < 80) {
                width += Math.random() * 1.5; // ä¸­æœŸï¼šæ”¾æ…¢
            } else if (width < 95) {
                width += Math.random() * 0.3; // å¾ŒæœŸï¼šæ¥µæ…¢çˆ¬è¡Œ
            }
            
            if (width > 95) width = 95; 
            progressBar.style.width = width + "%";
        }, 250);
    }

    function stopLoading() { 
        clearInterval(progressInterval); 
        progressBar.style.width = "100%"; 
        setTimeout(() => { loadingContainer.style.display = "none"; }, 600); 
    }

    function startLottery(code) {
        startLoading();
        fetch(`${GAS_API_URL}?code=${encodeURIComponent(code)}`)
            .then(res => res.json())
            .then(data => {
                stopLoading(); 
                updateNotice(data.notice);
                if (data.status === "error") { 
                    errorArea.innerHTML = `âŒ ${data.message}`; 
                    document.getElementById("inputSection").style.display = "block"; 
                    return; 
                }
                setupScratchCard(data);
            })
            .catch(err => { 
                stopLoading(); 
                errorArea.innerText = "é€£ç·šå¤±æ•—"; 
                document.getElementById("inputSection").style.display = "block"; 
            });
    }

    function setupScratchCard(data) {
        wrapper.style.display = "block";
        prizeDiv.innerText = data.prizeName;
        prizeUrlData = data.prizeUrl || "";

        let btnText = "ğŸ‘‰ é»æˆ‘å‰å¾€é ˜å–å…Œæ›å·";
        if (data.prizeName.includes("é»æ•¸")) btnText = "ğŸ‘‰ é»æˆ‘å‰å¾€LINEé ˜å–é»æ•¸";
        else if (data.prizeName.includes("æŠ˜")) btnText = "ğŸ‘‰ é»æˆ‘å‰å¾€é ˜å–å„ªæƒ å·";
        rewardLink.innerText = btnText;

        if (data.result === "played") {
             errorArea.innerHTML = "<small style='color:#f57f17'>âš ï¸ æ­¤ç¦®ç‰©å·²é ˜éï¼Œé€™æ˜¯æ‚¨çš„çé …ï¼š</small>";
             canvas.style.display = "none"; hint.style.display = "none"; revealBtn.style.display = "none"; 
             if (prizeUrlData) { rewardLink.href = prizeUrlData; rewardLink.style.display = "inline-block"; }
        } else {
             revealBtn.style.display = "inline-block";
             resetCanvas(); initScratchEvents(); 
        }
    }

    function resetCanvas() {
        canvas.style.display = "block"; canvas.style.opacity = "1"; hint.style.display = "block";
        ctx.globalCompositeOperation = "source-over";
        ctx.fillStyle = "#FFD700"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#B8860B"; ctx.font = "bold 24px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
        ctx.fillText("ğŸ„ Merry X'mas ğŸ„", canvas.width/2, canvas.height/2);
    }

    function scratch(e) {
        e.preventDefault();
        if (!isDrawing) return;
        if (!firstScratch) { hint.style.display = "none"; firstScratch = true; }
        const rect = canvas.getBoundingClientRect();
        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
        const clientY = e.clientY || (e.touches && e.touches[0].clientY);
        ctx.globalCompositeOperation = "destination-out";
        ctx.beginPath();
        ctx.arc(clientX - rect.left, clientY - rect.top, 22, 0, Math.PI * 2);
        ctx.fill();
        checkPercent();
    }

    function checkPercent() {
        if (Math.random() > 0.1) return;
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        let cleared = 0;
        for (let i = 3; i < imageData.data.length; i += 16) { if (imageData.data[i] === 0) cleared++; }
        const totalSamples = (canvas.width * canvas.height) / 4;
        const percent = (cleared / totalSamples) * 100;
        if (percent > 70 && canvas.style.opacity !== "0") { 
            revealPrize();
        }
    }

    function revealPrize() {
        canvas.style.opacity = "0"; hint.style.display = "none";
        setTimeout(() => {
            canvas.style.display = "none"; revealBtn.style.display = "none";
            if (prizeUrlData) { rewardLink.href = prizeUrlData; rewardLink.style.display = "inline-block"; }
        }, 600);
    }

    function initScratchEvents() {
        canvas.onmousedown = () => isDrawing = true; window.onmouseup = () => isDrawing = false; canvas.onmousemove = scratch;
        canvas.ontouchstart = (e) => { isDrawing = true; e.preventDefault(); }; window.ontouchend = () => isDrawing = false; canvas.ontouchmove = scratch;
        revealBtn.onclick = revealPrize;
    }

    document.body.addEventListener("touchmove", function(e) { if (e.target === canvas) e.preventDefault(); }, { passive: false });
  </script>
</body>
</html>
