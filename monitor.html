<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ… è–èª•æ­¡æ¨‚é–‹ççœ‹æ¿ ğŸ„</title>
  <style>
    /* ----- æº«é¦¨è–èª•ä¸»é¡Œ ----- */
    :root {
      --bg-color: #FFF5EE; 
      --card-bg: #ffffff;
      --primary-red: #d32f2f;
      --primary-green: #2e7d32;
      --gold: #fbc02d;
      --text-color: #5d4037; 
    }

    body {
      background: linear-gradient(180deg, #FFF5EE 0%, #ffebee 100%);
      color: var(--text-color);
      font-family: "å¾®è»Ÿæ­£é»‘é«”", "Segoe UI", sans-serif;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* æ¨™é¡Œè£é£¾ */
    h1 {
      color: var(--primary-red);
      font-size: 3em;
      margin-bottom: 30px;
      text-shadow: 2px 2px 0px #fff, 4px 4px 10px rgba(0,0,0,0.1);
      position: relative;
      z-index: 10;
    }
    h1::after {
      content: "ğŸ"; font-size: 0.6em; position: absolute;
      top: -10px; right: -50px; animation: swing 2s infinite ease-in-out;
    }

    /* å„€è¡¨æ¿ä½ˆå±€ */
    .dashboard {
      display: flex; flex-wrap: wrap; gap: 25px;
      width: 100%; max-width: 1200px;
      justify-content: center; align-items: flex-start;
      z-index: 10; 
    }

    .left-panel { flex: 1; min-width: 300px; display: flex; flex-direction: column; gap: 25px; }
    .right-panel { flex: 1.5; min-width: 350px; display: flex; flex-direction: column; height: 650px; }

    /* é€šç”¨å¡ç‰‡æ¨£å¼ */
    .card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(166, 124, 82, 0.15);
      border: 2px solid #fff;
      position: relative;
      overflow: hidden;
    }
    .card::before {
      content: ""; position: absolute; top: 0; left: 0; right: 0; height: 6px;
      background: repeating-linear-gradient(45deg, var(--primary-red), var(--primary-red) 10px, #fff 10px, #fff 20px);
    }

    /* ç¸½æ•¸å¡ç‰‡ */
    .stat-title { font-size: 20px; color: #8d6e63; margin-bottom: 5px; font-weight: bold; }
    .stat-number {
      font-size: 90px; font-weight: 900; color: var(--primary-green);
      margin: 10px 0; text-shadow: 2px 2px 0px #e8f5e9; font-family: 'Arial Black', sans-serif;
    }
    
    .live-status {
      display: inline-flex; align-items: center;
      background: #e8f5e9; color: var(--primary-green);
      padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: bold;
    }
    .live-dot {
      width: 10px; height: 10px; background: var(--primary-green);
      border-radius: 50%; margin-right: 8px; animation: pulse 1.5s infinite;
    }

    /* åˆ†é¡çµ±è¨ˆ */
    .breakdown-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px;
    }
    .prize-mini-card {
      background: #fff8e1; padding: 15px; border-radius: 12px; text-align: center;
      border: 1px solid #ffe0b2;
    }
    .prize-name { font-size: 14px; color: #795548; margin-bottom: 5px; }
    .prize-count { font-size: 24px; color: var(--primary-red); font-weight: bold; }

    /* å³å´åˆ—è¡¨ */
    .panel-header {
      font-size: 22px; font-weight: bold; color: var(--primary-red);
      margin-bottom: 15px; padding-bottom: 10px;
      border-bottom: 2px dashed #ffcdd2;
      display: flex; align-items: center; gap: 10px;
    }
    .log-list {
      list-style: none; padding: 0; margin: 0;
      overflow-y: auto; flex: 1; padding-right: 5px;
    }
    .log-list::-webkit-scrollbar { width: 6px; }
    .log-list::-webkit-scrollbar-thumb { background: #ffccbc; border-radius: 3px; }

    .log-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px; margin-bottom: 10px;
      background: #fff; border-radius: 10px;
      border-left: 5px solid var(--gold);
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      /* ç§»é™¤å‹•ç•«ï¼Œè§£æ±ºé–ƒçˆå•é¡Œ */
      /* animation: slideIn 0.5s ease; */ 
    }
    .log-time { color: #999; font-size: 13px; font-family: monospace; }
    .log-user { color: #333; font-weight: bold; flex: 1; margin-left: 15px; font-size: 16px; }
    .log-prize { 
      color: var(--primary-red); font-weight: bold; 
      background: #ffebee; padding: 5px 10px; border-radius: 15px; font-size: 14px;
    }

    /* é›ªèŠ±ç‰¹æ•ˆ */
    .snowflake {
      position: fixed; top: -10px; z-index: 1;
      color: #fff; text-shadow: 0 0 5px rgba(0,0,0,0.1);
      animation: fall linear infinite; pointer-events: none;
    }

    @keyframes fall { to { transform: translateY(100vh) rotate(360deg); } }
    @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } 100% { opacity: 1; transform: scale(1); } }
    @keyframes swing { 0% { transform: rotate(0deg); } 25% { transform: rotate(10deg); } 75% { transform: rotate(-10deg); } 100% { transform: rotate(0deg); } }

    /* RWD */
    @media (max-width: 768px) {
      h1 { font-size: 2em; }
      .stat-number { font-size: 60px; }
      .right-panel { height: 500px; }
    }
  </style>
</head>
<body>

  <h1>ğŸ… è–èª•æ­¡æ¨‚é–‹ççœ‹æ¿ ğŸ„</h1>

  <div class="dashboard">
    
    <div class="left-panel">
      <div class="card" style="text-align: center;">
        <div class="stat-title">ğŸ“… ä»Šæ—¥å·²é€å‡ºç¦®ç‰©</div>
        <div class="stat-number" id="countDisplay">0</div>
        <div class="live-status">
          <span class="live-dot"></span> å³æ™‚é€£ç·šä¸­
        </div>
      </div>

      <div class="card">
        <div class="panel-header">ğŸ“Š ç¦®ç‰©æ´¾ç™¼ç‹€æ³</div>
        <div class="breakdown-grid" id="breakdownGrid">
          <div style="color:#999; font-size:14px; grid-column:1/-1; text-align:center;">è¼‰å…¥ä¸­...</div>
        </div>
      </div>
    </div>

    <div class="right-panel card">
      <div class="panel-header">ğŸ“ æœ€æ–°å¹¸é‹å…’åå–®</div>
      <ul class="log-list" id="logList">
        <li style="text-align:center; padding:20px; color:#999;">ç­‰å¾…è–èª•è€äººæ´¾é€ä¸­...</li>
      </ul>
    </div>

  </div>

  <script>
    // âš ï¸ è«‹å¡«å…¥ä½ çš„ GAS ç¶²å€
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxHEwjdt1URWlRsDpuZFn-Mgqi62l_vSjtAa9up21d37UblgtnNPQgmW3SkDZTe_S2jtw/exec";

    const countDisplay = document.getElementById("countDisplay");
    const logList = document.getElementById("logList");
    const breakdownGrid = document.getElementById("breakdownGrid");
    
    // å„²å­˜ä¸Šä¸€æ¬¡çš„åˆ—è¡¨ HTMLï¼Œç”¨ä¾†æ¯”å°æ˜¯å¦éœ€è¦æ›´æ–°
    let lastLogHtml = "";

    createSnow();
    fetchData();
    setInterval(fetchData, 5000);

    function fetchData() {
      fetch(`${GAS_API_URL}?action=getDashboard`)
        .then(res => res.json())
        .then(data => {
          updateUI(data);
        })
        .catch(err => console.error("Update failed", err));
    }

    function updateUI(data) {
      // 1. æ›´æ–°ç¸½æ•¸ (åªæœ‰æ•¸å­—è®Šäº†æ‰è·³å‹•)
      const currentCount = parseInt(countDisplay.innerText);
      if (currentCount !== data.todayCount) {
        countDisplay.innerText = data.todayCount;
        countDisplay.style.transform = "scale(1.1)";
        setTimeout(() => countDisplay.style.transform = "scale(1)", 200);
      }

      // 2. æ›´æ–°åˆ†é¡
      updateBreakdown(data.prizeCounts);

      // 3. æ›´æ–°åˆ—è¡¨ (é˜²é–ƒçˆæ ¸å¿ƒé‚è¼¯)
      updateLogList(data.recentLogs);
    }

    function updateBreakdown(counts) {
      if (!counts || Object.keys(counts).length === 0) {
        breakdownGrid.innerHTML = '<div style="color:#aaa; font-size:14px; grid-column:1/-1; text-align:center;">ä»Šæ—¥å°šç„¡ç¦®ç‰©é€å‡º</div>';
        return;
      }
      const sortedPrizes = Object.entries(counts).sort((a, b) => b[1] - a[1]);
      let html = "";
      sortedPrizes.forEach(([name, count]) => {
        html += `
          <div class="prize-mini-card">
            <div class="prize-name">${name}</div>
            <div class="prize-count">${count}</div>
          </div>
        `;
      });
      breakdownGrid.innerHTML = html;
    }

    function updateLogList(logs) {
      if (logs.length === 0) {
        logList.innerHTML = '<li style="text-align:center; padding:40px; color:#aaa;">ä»Šæ—¥å°šç„¡ç´€éŒ„</li>';
        return;
      }
      
      let html = "";
      logs.forEach(log => {
        html += `
          <li class="log-item">
            <span class="log-time">${log.time}</span>
            <span class="log-user">${log.code}</span>
            <span class="log-prize">ğŸ ${log.prize}</span>
          </li>
        `;
      });

      // é—œéµä¿®æ”¹ï¼šåªæœ‰ç•¶å…§å®¹çœŸçš„ä¸ä¸€æ¨£æ™‚ï¼Œæ‰å¯«å…¥ DOM
      // é€™èƒ½é˜²æ­¢ç€è¦½å™¨é‡æ–°æ¸²æŸ“é€ æˆçš„é–ƒçˆ
      if (html !== lastLogHtml) {
        logList.innerHTML = html;
        lastLogHtml = html; // æ›´æ–°å¿«å–
      }
    }

    function createSnow() {
      const symbols = ['â„', 'â…', 'â†', 'â€¢'];
      setInterval(() => {
        const snowflake = document.createElement('div');
        snowflake.classList.add('snowflake');
        snowflake.innerText = symbols[Math.floor(Math.random() * symbols.length)];
        snowflake.style.left = Math.random() * 100 + 'vw';
        snowflake.style.animationDuration = Math.random() * 3 + 5 + 's'; 
        snowflake.style.opacity = Math.random();
        snowflake.style.fontSize = Math.random() * 10 + 10 + 'px';
        document.body.appendChild(snowflake);
        setTimeout(() => { snowflake.remove(); }, 10000);
      }, 300);
    }
  </script>

</body>
</html>
